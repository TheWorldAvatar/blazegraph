# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven
name: Java CI with Maven
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      id: setup-java
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B install -DskipTests -P github-twa-deploy,Development
    - name: Always Save .m2
      if: always() && steps.setup-java.outputs.cache-hit == 'true'
      uses: actions/cache/save@v4
      with:
        key: ${{ steps.setup-java.outputs.cache-primary-key }}
        path: |
          ${{ steps.setup-java.inputs.cache-dependency-path }}
  test:
    needs: build
    strategy:
      matrix:
        project: [junit-ext, blazegraph-colt, ctc-striterators, lgpl-utils, dsi-utils, system-utils, rdf-properties, sparql-grammar, bigdata-util, bigdata-common-util, bigdata-statics, bigdata-cache, bigdata-client, bigdata-ganglia, bigdata-gas, bigdata-core, vocabularies, bigdata-war-html, bigdata-blueprints, bigdata-runtime, bigdata-rdf-test, blazegraph-artifacts]
        include:
          - project: bigdata-core-test
            test: -Dsurefire.excludes=com/bigdata/journal/TestAll.java,com/bigdata/rwstore/TestAll.java,com/bigdata/bop/TestAll.java,com/bigdata/btree/TestAll.java,com/bigdata/TestAll.java,com/bigdata/bfs/TestAll.java
          - project: bigdata-core-test
            test: -Dtest=com/bigdata/journal/TestAll.java
          - project: bigdata-core-test
            test: -Dtest=com/bigdata/rwstore/TestAll.java
          - project: bigdata-core-test
            test: -Dtest=com/bigdata/bop/TestAll.java
          - project: bigdata-core-test
            test: -Dtest=com/bigdata/btree/TestAll.java
          - project: bigdata-sails-test
            test: -Dtest=com.bigdata.rdf.sail.sparql.TestAll
          - project: bigdata-sails-test
            test: -Dtest=TestBootstrapBigdataSail
          - project: bigdata-sails-test
            test: -Dtest=TestBigdataSailWithSids
          - project: bigdata-sails-test
            test: -Dtest=TestBigdataSailWithoutSids
          - project: bigdata-sails-test
            test: -Dtest=TestBigdataSailWithQuads
          - project: bigdata-sails-test
            test: -Dtest=com.bigdata.rdf.sail.tck.TestAll
          - project: bigdata-sails-test
            test: -Dtest=com.bigdata.rdf.sail.webapp.TestAll
    runs-on:  ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B ${{matrix.test}} test -Dsurefire.rerunFailingTestsCount=2 -f ${{matrix.project}}/pom.xml -P github-twa-deploy,Development
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
